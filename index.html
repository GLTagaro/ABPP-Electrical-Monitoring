<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Request Monitoring Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #94a3b8;
            border-radius: 9999px;
            border: 2px solid #f1f5f9;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: #64748b;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans min-h-screen p-4 md:p-8 flex flex-col items-center justify-center">
    <div class="w-full max-w-4xl bg-white rounded-xl shadow-2xl p-6 md:p-8 space-y-8 flex flex-col lg:flex-row lg:space-x-8 lg:space-y-0">
        <div class="flex-1 space-y-6">
            <h1 class="text-3xl md:text-4xl font-bold text-center text-indigo-700">Monitoring Dashboard</h1>
            <div class="flex flex-col sm:flex-row gap-4">
                <input type="text" id="search-input" placeholder="Search by BRF NO., PR NO., PO NO., or RS NO."
                        class="w-full sm:flex-1 p-3 rounded-lg border-2 border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all duration-200">
                <select id="status-filter" class="w-full sm:w-auto p-3 rounded-lg border-2 border-slate-200 bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all duration-200">
                    <option value="">All Statuses</option>
                    <option value="RS SENT">RS SENT</option>
                    <option value="BRF CREATION">BRF CREATION</option>
                    <option value="BRF FOR SIGNING">BRF FOR SIGNING</option>
                    <option value="BRF SIGNED">BRF SIGNED</option>
                    <option value="PR CREATION">PR CREATION</option>
                    <option value="PR FOR SIGNING">PR FOR SIGNING</option>
                    <option value="PR SIGNED">PR SIGNED</option>
                    <option value="UPLOADED TO SP">UPLOADED TO SP</option>
                    <option value="DONE">DONE</option>
                    <option value="AGREEMENT CANCELLED">AGREEMENT CANCELLED</option>
                </select>
            </div>
            <div class="flex flex-col lg:flex-row gap-6">
                <div class="flex-1 space-y-6">
                    <div class="bg-slate-50 rounded-lg p-4 shadow-inner">
                        <div id="sheets-container" class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        </div>
                    </div>
                    <div class="bg-slate-50 rounded-lg p-4 shadow-inner">
                        <h2 class="text-xl font-semibold text-slate-700 mb-4">Requests</h2>
                        <div id="requests-container" class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar pr-2">
                            <p class="text-center text-slate-400">Please select a sheet to view requests.</p>
                        </div>
                    </div>
                </div>
                <div class="flex-1 bg-slate-50 rounded-lg p-4 shadow-inner flex flex-col justify-center items-center text-center">
                    <h2 class="text-xl font-semibold text-slate-700 mb-4">Request Details</h2>
                    <div id="details-container" class="text-lg text-slate-600 space-y-4 w-full">
                        <p>Please select a request to view its details.</p>
                    </div>
                    <div id="update-form-container" class="w-full mt-6 hidden">
                      <form id="update-form" class="space-y-4">
                        <input type="hidden" id="rs-number" name="rsNumber">
                        <input type="hidden" id="brf-number" name="brfNumber">
                        <div class="space-y-2">
                          <label for="new-status" class="block text-sm font-medium text-slate-700 text-left">Update Status:</label>
                          <select id="new-status" name="newStatus" class="w-full p-3 rounded-lg border-2 border-slate-200 bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="RS SENT">RS SENT</option>
                            <option value="BRF CREATION">BRF CREATION</option>
                            <option value="BRF FOR SIGNING">BRF FOR SIGNING</option>
                            <option value="BRF SIGNED">BRF SIGNED</option>
                            <option value="PR CREATION">PR CREATION</option>
                            <option value="PR FOR SIGNING">PR FOR SIGNING</option>
                            <option value="PR SIGNED">PR SIGNED</option>
                            <option value="UPLOADED TO SP">UPLOADED TO SP</option>
                            <option value="DONE">DONE</option>
                            <option value="AGREEMENT CANCELLED">AGREEMENT CANCELLED</option>
                          </select>
                        </div>
                        <button type="submit" class="w-full py-3 px-4 rounded-lg text-white font-semibold bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-colors duration-200">
                          Update Status
                        </button>
                      </form>
                      <p id="form-message" class="mt-4 text-sm font-medium"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        (async function() {
            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyfbJrcc0xVe7IKMqGH66RoxHYAEHKN23Q3LqagW7xbsC13PcWq5-6zC_JMzfBDqt83/exec';
            const spreadsheetId = '2PACX-1vTvMkhVlirDHrhIjD-5UjcEaznuKDxGr3ytRBUNCGeEoJ41kCCoJsFO4RmYq-M3AlViIDuDB7S_vdCa';
            const sheets = {
                'GLTAGARO': '0',
                'KSNOBLEZA': '1842592465',
            };
            
            const searchInput = document.getElementById('search-input');
            const statusFilter = document.getElementById('status-filter');
            const sheetsContainer = document.getElementById('sheets-container');
            const requestsContainer = document.getElementById('requests-container');
            const detailsContainer = document.getElementById('details-container');
            const updateFormContainer = document.getElementById('update-form-container');
            const updateForm = document.getElementById('update-form');
            const rsNumberInput = document.getElementById('rs-number'); 
            const brfNumberInput = document.getElementById('brf-number');
            const newStatusSelect = document.getElementById('new-status');
            const formMessage = document.getElementById('form-message');

            const dataCache = {};
            let activeSheetData = [];
            let activeSheetName = '';

            console.log("Script has started. Initializing dashboard.");

            async function fetchData(gid) {
                console.log(`Attempting to fetch data for GID: ${gid}`);
                try {
                    const response = await fetch(`https://docs.google.com/spreadsheets/d/e/${spreadsheetId}/pub?output=csv&gid=${gid}`);
                    console.log(`Fetch response received. Status: ${response.status}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const csvText = await response.text();
                    console.log("CSV text received, parsing data.");
                    return parseCsv(csvText);
                } catch (error) {
                    console.error('Could not fetch data:', error);
                    requestsContainer.innerHTML = '<p class="text-center text-red-500">Failed to load requests. Please check the URL and GID.</p>';
                    return null;
                }
            }

            function parseCsv(csvText) {
                console.log("Starting CSV parsing.");
                const lines = csvText.split('\n').filter(line => line.trim() !== '');
                if (lines.length < 2) {
                    console.log("CSV is empty or has no header.");
                    return [];
                }
                const headers = lines[0].split(',').map(header => header.trim().toUpperCase());
                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(value => value.trim());
                    const row = {};
                    headers.forEach((header, index) => {
                        if (values[index] !== undefined) {
                            row[header] = values[index];
                        }
                    });
                    data.push(row);
                }
                console.log("CSV parsing complete. Number of rows:", data.length);
                return data;
            }

            function renderButtons(data) {
                console.log("Rendering buttons.");
                if (data.length === 0) {
                    requestsContainer.innerHTML = '<p class="text-center text-slate-400">No requests found.</p>';
                    return;
                }
                requestsContainer.innerHTML = '';
                data.forEach((request, index) => {
                    const button = document.createElement('button');
                    const title = request['TITLE'] || `Request ${index + 1}`;
                    button.textContent = title;
                    button.classList.add('w-full', 'py-3', 'px-4', 'text-left', 'bg-white', 'text-indigo-600', 'font-medium', 'rounded-lg', 'shadow-sm', 'hover:bg-indigo-50', 'transition-colors', 'duration-200', 'focus:outline-none', 'focus:ring-2', 'focus:ring-indigo-500', 'focus:ring-offset-2', 'whitespace-normal');
                    button.addEventListener('click', () => displayDetails(request));
                    requestsContainer.appendChild(button);
                });
            }

            function displayDetails(request) {
                console.log("Displaying details for a request.");
                const currentStatus = request['STATUS'] || 'N/A';
                detailsContainer.innerHTML = `
                    <div class="bg-indigo-50 p-6 rounded-lg w-full text-left space-y-3">
                        <div class="flex justify-between items-center">
                            <h3 class="text-2xl font-bold text-indigo-700">Status</h3>
                            <span class="px-3 py-1 font-semibold rounded-full text-sm ${getStatusClass(currentStatus)}">
                                ${currentStatus}
                            </span>
                        </div>
                        <div class="border-t border-indigo-200 pt-4 space-y-2">
                            <p><strong>RS NO.:</strong> ${request['RS NO.'] || 'N/A'}</p>
                            <p><strong>BRF NO.:</strong> ${request['BRF NO.'] || 'N/A'}</p>
                            <p><strong>PR NO.:</strong> ${request['PR NO.'] || 'N/A'}</p>
                            <p><strong>PO NO.:</strong> ${request['PO NO.'] || 'N/A'}</p>
                            <p><strong>ICAR:</strong> ${request['ICAR'] || 'N/A'}</p>
                        </div>
                    </div>
                `;
                updateFormContainer.classList.remove('hidden');
                rsNumberInput.value = request['RS NO.'] || '';
                brfNumberInput.value = request['BRF NO.'] || '';
                newStatusSelect.value = currentStatus;
                formMessage.textContent = '';
            }

            function getStatusClass(status) {
                const s = (status || '').toUpperCase().trim();
                switch (s) {
                    case 'RS SENT': return 'bg-purple-200 text-purple-800';
                    case 'BRF CREATION': return 'bg-indigo-200 text-indigo-800';
                    case 'BRF FOR SIGNING': return 'bg-blue-200 text-blue-800';
                    case 'BRF SIGNED': return 'bg-cyan-200 text-cyan-800';
                    case 'PR CREATION': return 'bg-sky-200 text-sky-800';
                    case 'PR FOR SIGNING': return 'bg-emerald-200 text-emerald-800';
                    case 'PR SIGNED': return 'bg-teal-200 text-teal-800';
                    case 'UPLOADED TO SP': return 'bg-orange-200 text-orange-800';
                    case 'DONE': return 'bg-green-200 text-green-800';
                    case 'AGREEMENT CANCELLED': return 'bg-red-200 text-red-800';
                    default: return 'bg-gray-200 text-gray-800';
                }
            }
            
            function updateDashboard() {
                console.log("Updating dashboard with filters.");
                let filteredData = activeSheetData;
                const query = searchInput.value.toLowerCase().trim();
                const selectedStatus = statusFilter.value.toUpperCase().trim();
                if (selectedStatus) {
                    filteredData = filteredData.filter(request => (request['STATUS'] || 'Other').toUpperCase().trim() === selectedStatus);
                }
                if (query) {
                    filteredData = filteredData.filter(request => (
                        request['BRF NO.']?.toLowerCase().includes(query) ||
                        request['PR NO.']?.toLowerCase().includes(query) ||
                        request['PO NO.']?.toLowerCase().includes(query) ||
                        request['RS NO.']?.toLowerCase().includes(query)
                    ));
                }
                renderButtons(filteredData);
                detailsContainer.innerHTML = '<p>Please select a request to view its details.</p>';
                updateFormContainer.classList.add('hidden');
            }

            async function loadSheet(sheetName) {
                console.log(`Loading sheet: ${sheetName}`);
                requestsContainer.innerHTML = '<p class="text-center text-slate-400">Loading requests...</p>';
                detailsContainer.innerHTML = '<p>Please select a request to view its details.</p>';
                document.querySelectorAll('#sheets-container button').forEach(btn => {
                    btn.classList.remove('bg-indigo-500', 'text-white', 'shadow-md');
                    btn.classList.add('bg-white', 'text-indigo-600');
                    if (btn.textContent === sheetName) {
                        btn.classList.remove('bg-white', 'text-indigo-600');
                        btn.classList.add('bg-indigo-500', 'text-white', 'shadow-md');
                    }
                });
                
                activeSheetName = sheetName;
                const gid = sheets[sheetName];
                if (dataCache[sheetName]) {
                    activeSheetData = dataCache[sheetName];
                    updateDashboard();
                } else {
                    const data = await fetchData(gid);
                    if (data) {
                        dataCache[sheetName] = data;
                        activeSheetData = data;
                        updateDashboard();
                    } else {
                        activeSheetData = [];
                    }
                }
            }

            async function initializeApp() {
                console.log("Starting initializeApp.");
                for (const sheetName in sheets) {
                    const button = document.createElement('button');
                    button.textContent = sheetName;
                    button.classList.add('py-3', 'px-4', 'font-medium', 'rounded-lg', 'shadow-sm', 'transition-colors', 'duration-200', 'focus:outline-none', 'focus:ring-2', 'focus:ring-indigo-500', 'focus:ring-offset-2', 'bg-white', 'text-indigo-600', 'hover:bg-indigo-50', 'whitespace-normal');
                    button.addEventListener('click', () => loadSheet(sheetName));
                    sheetsContainer.appendChild(button);
                }
                await loadSheet(Object.keys(sheets)[0]);
                console.log("App initialization complete.");
            }

            searchInput.addEventListener('keyup', updateDashboard);
            statusFilter.addEventListener('change', updateDashboard);

            updateForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log("Update form submitted.");
                const data = {
                    sheetName: activeSheetName,
                    rsNumber: rsNumberInput.value,
                    brfNumber: brfNumberInput.value,
                    newStatus: newStatusSelect.value,
                };
                
                const submitButton = updateForm.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.textContent = 'Updating...';
                formMessage.className = 'mt-4 text-sm font-medium';
                formMessage.textContent = '';
                const body = new URLSearchParams(data).toString();

                try {
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: body,
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        formMessage.textContent = result.message;
                        formMessage.classList.add('text-green-600');
                        await loadSheet(activeSheetName);
                    } else {
                        formMessage.textContent = `Error: ${result.message}`;
                        formMessage.classList.add('text-red-600');
                    }
                } catch (error) {
                    console.error('Update failed:', error);
                    formMessage.textContent = `An unexpected error occurred: ${error.message}`;
                    formMessage.classList.add('text-red-600');
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Update Status';
                }
            });
            
            initializeApp();
        })();
    </script>
</body>
</html>
